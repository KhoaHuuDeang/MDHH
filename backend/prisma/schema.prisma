generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model accounts {
  id                  String  @id @default(uuid()) @db.Uuid
  user_id             String? @db.Uuid
  type                String? @db.VarChar
  provider            String? @db.VarChar
  provider_account_id String? @db.VarChar
  refresh_token       String?
  access_token        String?
  expires_at          Int?
  token_type          String? @db.VarChar
  scope               String? @db.VarChar
  id_token            String?
  session_state       String? @db.VarChar
  metadata            Json?   @db.Json
  users               users?  @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([provider, provider_account_id])
}

model classification_levels {
  id          String    @id @default(uuid()) @db.Uuid
  name        String?   @unique @db.VarChar
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  folders     folders[]
  tags        tags[]
}

model comments {
  id                   String                 @id @default(uuid()) @db.Uuid
  user_id              String?                @db.Uuid
  resource_id          String?                @db.Uuid
  folder_id            String?                @db.Uuid
  parent_id            String?                @db.Uuid
  content              String?
  is_deleted           Boolean?               @default(false)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?              @default(now()) @db.Timestamptz(6)
  folders              folders?               @relation(fields: [folder_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  comments             comments?              @relation("commentsTocomments", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_comments       comments[]             @relation("commentsTocomments")
  resources            resources?             @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                users?                 @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  notification_targets notification_targets[]
  ratings_comments     ratings_comments[]
}

model downloads {
  id            String     @id @default(uuid()) @db.Uuid
  user_id       String?    @db.Uuid
  resource_id   String?    @db.Uuid
  downloaded_at DateTime?  @default(now()) @db.Timestamptz(6)
  resources     resources? @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users         users?     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([resource_id, downloaded_at(sort: Desc)], map: "idx_downloads_resource_downloaded_at")
}

model folder_files {
  folder_id   String    @db.Uuid
  resource_id String    @db.Uuid
  folders     folders   @relation(fields: [folder_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  resources   resources @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([folder_id, resource_id])
}

model folder_tags {
  folder_id String  @db.Uuid
  tag_id    String  @db.Uuid
  folders   folders @relation(fields: [folder_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tags      tags    @relation(fields: [tag_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([folder_id, tag_id])
}

model folders {
  id                      String                 @id @default(uuid()) @db.Uuid
  name                    String?                @db.VarChar
  visibility              Visibility?            @default(PUBLIC)
  created_at              DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at              DateTime?              @default(now()) @db.Timestamptz(6)
  user_id                 String                 @db.Uuid
  classification_level_id String                 @db.Uuid
  description             String?
  comments                comments[]
  folder_files            folder_files[]
  folder_tags             folder_tags[]
  classification_levels   classification_levels  @relation(fields: [classification_level_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                   users                  @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  follows                 follows[]
  notification_targets    notification_targets[]
  ratings_folders         ratings_folders[]
}

model follows {
  user_id     String    @db.Uuid
  folder_id   String    @db.Uuid
  followed_at DateTime? @default(now()) @db.Timestamptz(6)
  folders     folders   @relation(fields: [folder_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users       users     @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([user_id, folder_id])
  @@index([folder_id, followed_at(sort: Desc)], map: "idx_follows_folder_followed_at")
}

model notification_targets {
  id              String        @id @default(uuid()) @db.Uuid
  notification_id String        @db.Uuid
  resource_id     String?       @db.Uuid
  folder_id       String?       @db.Uuid
  comment_id      String?       @db.Uuid
  comments        comments?     @relation(fields: [comment_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  folders         folders?      @relation(fields: [folder_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  notifications   notifications @relation(fields: [notification_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  resources       resources?    @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([notification_id, resource_id, folder_id, comment_id])
}

model notifications {
  id                   String                 @id @default(uuid()) @db.Uuid
  actor_id             String?                @db.Uuid
  type                 NotificationType?
  message              String?
  is_read              Boolean?               @default(false)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  read_at              DateTime?              @db.Timestamptz(6)
  notification_targets notification_targets[]
  users                users?                 @relation(fields: [actor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model ratings {
  id                String              @id @default(uuid()) @db.Uuid
  user_id           String?             @db.Uuid
  value             Int?
  rated_at          DateTime?           @default(now()) @db.Timestamptz(6)
  users             users?              @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ratings_comments  ratings_comments[]
  ratings_folders   ratings_folders[]
  ratings_resources ratings_resources[]

  @@index([user_id, rated_at(sort: Desc)], map: "idx_ratings_user_rated_at")
}

model ratings_comments {
  id         String   @id @default(uuid()) @db.Uuid
  rating_id  String   @db.Uuid
  comment_id String   @db.Uuid
  comments   comments @relation(fields: [comment_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ratings    ratings  @relation(fields: [rating_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([rating_id, comment_id])
}

model ratings_folders {
  id        String  @id @default(uuid()) @db.Uuid
  rating_id String  @db.Uuid
  folder_id String  @db.Uuid
  folders   folders @relation(fields: [folder_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  ratings   ratings @relation(fields: [rating_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([rating_id, folder_id])
  @@index([folder_id], map: "idx_ratings_folders_folder_id")
}

model ratings_resources {
  id          String    @id @default(uuid()) @db.Uuid
  rating_id   String    @db.Uuid
  resource_id String    @db.Uuid
  ratings     ratings   @relation(fields: [rating_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  resources   resources @relation(fields: [resource_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([rating_id, resource_id])
  @@index([resource_id], map: "idx_ratings_resources_resource_id")
}

model resource_tags {
  resource_id String    @db.Uuid
  tag_id      String    @db.Uuid
  resources   resources @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tags        tags      @relation(fields: [tag_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([resource_id, tag_id])
}

model resources {
  id                   String                 @id @default(uuid()) @db.Uuid
  title                String?                @db.VarChar
  description          String?
  category             String?                @db.VarChar
  visibility           Visibility?            @default(PUBLIC)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  comments             comments[]
  downloads            downloads[]
  folder_files         folder_files[]
  notification_targets notification_targets[]
  ratings_resources    ratings_resources[]
  resource_tags        resource_tags[]
  uploads              uploads[]
}

model roles {
  id          String    @id @default(uuid()) @db.Uuid
  name        RoleType  @unique
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  users       users[]
}

model sessions {
  id            String    @id @default(uuid()) @db.Uuid
  session_token String?   @unique @db.VarChar
  user_id       String?   @db.Uuid
  expires       DateTime? @db.Timestamptz(6)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)
  users         users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model tags {
  id                    String                @id @default(uuid()) @db.Uuid
  level_id              String                @db.Uuid
  name                  String?               @db.VarChar
  description           String?
  created_at            DateTime?             @default(now()) @db.Timestamptz(6)
  folder_tags           folder_tags[]
  resource_tags         resource_tags[]
  classification_levels classification_levels @relation(fields: [level_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([name, level_id])
}

model uploads {
  id                 String             @id @default(uuid()) @db.Uuid
  user_id            String?            @db.Uuid
  resource_id        String?            @db.Uuid
  file_name          String?            @db.VarChar
  mime_type          String?            @db.VarChar
  file_size          Int?
  s3_key             String?            @db.VarChar
  status             UploadStatus?      @default(PENDING)
  moderation_status  ModerationStatus?  @default(PENDING_APPROVAL)
  moderation_reason  String?
  moderated_by       String?            @db.Uuid
  moderated_at       DateTime?          @db.Timestamptz(6)
  created_at         DateTime?          @default(now()) @db.Timestamptz(6)
  uploaded_at        DateTime?          @db.Timestamptz(6)
  title              String?            @db.VarChar
  description        String?
  visibility         Visibility?        @default(PUBLIC)
  resources          resources?         @relation(fields: [resource_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users              users?             @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id, created_at(sort: Desc)], map: "idx_uploads_user_created_at")
  @@index([status, created_at(sort: Desc)], map: "idx_uploads_status_created_at")
  @@index([moderation_status, created_at(sort: Desc)], map: "idx_uploads_moderation_status_created_at")
}

model user_guild_roles {
  id        String    @id @default(uuid()) @db.Uuid
  user_id   String?   @db.Uuid
  guild_id  String?   @db.Uuid
  role_name RoleType?
  users     users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([user_id, guild_id, role_name])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model users {
  id               String             @id @default(uuid()) @db.Uuid
  email            String?            @unique @db.VarChar
  username         String?            @unique @db.VarChar
  displayname      String?            @db.VarChar
  password         String?            @db.VarChar
  birth            String?            @db.VarChar
  avatar           String?            @db.VarChar
  banner           String?            @db.VarChar
  email_verified   Boolean?           @default(false)
  created_at       DateTime?          @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?          @default(now()) @db.Timestamptz(6)
  role_id          String             @db.Uuid
  is_disabled      Boolean            @default(false)
  disabled_until   DateTime?          @db.Timestamptz(6)
  disabled_reason      String?            @db.VarChar
  disabled_by          String?            @db.Uuid
  disabled_at          DateTime?          @db.Timestamptz(6)
  verification_token   String?            @unique @db.VarChar
  verification_expires DateTime?          @db.Timestamptz(6)
  reset_token          String?            @unique @db.VarChar
  reset_token_expires  DateTime?          @db.Timestamptz(6)
  accounts             accounts[]
  comments         comments[]
  downloads        downloads[]
  folders          folders[]
  follows          follows[]
  notifications    notifications[]
  ratings          ratings[]
  sessions         sessions[]
  uploads          uploads[]
  user_guild_roles user_guild_roles[]
  users            users?             @relation("usersTousers", fields: [disabled_by], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "disabled_by_user_fkey")
  other_users      users[]            @relation("usersTousers")
  roles            roles              @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  logs_received    logs[]             @relation("logs_user")
  logs_triggered   logs[]             @relation("logs_actor")
  cart_items       cart_items[]
  orders           orders[]

  @@index([created_at(sort: Desc), id(sort: Desc)], map: "idx_users_created_at_id")
}

/// The underlying table does not contain a valid unique identifier and can therefore currently not be handled by Prisma Client.
model verification_tokens {
  identifier String?   @db.VarChar
  token      String?   @unique @db.VarChar
  expires    DateTime? @db.Timestamptz(6)

  @@unique([identifier, token])
  @@ignore
}

enum NotificationType {
  UPLOAD
  DOWNLOAD
  COMMENT
  REPLY
  RATING
  FOLLOW
  SYSTEM
}

enum LogType {
  COMMENT
  UPVOTE
  DOWNVOTE
  APPROVED
  DECLINED
  UPLOAD_SUCCESS
  UPLOAD_FAILED
  DOWNLOAD
}

model logs {
  id          String   @id @default(uuid()) @db.Uuid
  user_id     String   @db.Uuid
  actor_id    String?  @db.Uuid
  type        LogType
  entity_type String?  @db.VarChar
  entity_id   String?  @db.Uuid
  message     String?
  is_read     Boolean  @default(false)
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  user  users  @relation("logs_user", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  actor users? @relation("logs_actor", fields: [actor_id], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([user_id, created_at(sort: Desc)], map: "idx_logs_user_created_at")
  @@index([user_id, is_read], map: "idx_logs_user_is_read")
}

enum ResourceStatus {
  PENDING
  ACTIVE
  ARCHIVED
}

enum RoleType {
  USER
  ADMIN
}

enum UploadStatus {
  PENDING
  COMPLETED
  FAILED
}

enum ModerationStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  FLAGGED
}

enum Visibility {
  PUBLIC
  PRIVATE
}

model souvenirs {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @db.VarChar
  description String?
  price       BigInt
  stock       Int       @default(0)
  image_url   String?   @db.VarChar
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @db.Timestamptz(6)
  cart_items  cart_items[]
  order_items order_items[]

  @@index([is_active, created_at(sort: Desc)])
}

model cart_items {
  id          String    @id @default(uuid()) @db.Uuid
  user_id     String    @db.Uuid
  souvenir_id String    @db.Uuid
  quantity    Int       @default(1)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  updated_at  DateTime  @default(now()) @db.Timestamptz(6)
  users       users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  souvenirs   souvenirs @relation(fields: [souvenir_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, souvenir_id])
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  PAID
  CANCELLED
  FAILED
  REFUNDED
}

model orders {
  id               String       @id @default(uuid()) @db.Uuid
  user_id          String       @db.Uuid
  total_amount     BigInt
  status           OrderStatus  @default(PENDING)
  payment_method   String?      @db.VarChar
  payment_ref      String?      @db.VarChar
  created_at       DateTime     @default(now()) @db.Timestamptz(6)
  updated_at       DateTime     @default(now()) @db.Timestamptz(6)
  users            users        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  order_items      order_items[]

  @@index([user_id, created_at(sort: Desc)])
  @@index([status])
}

model order_items {
  id          String    @id @default(uuid()) @db.Uuid
  order_id    String    @db.Uuid
  souvenir_id String    @db.Uuid
  quantity    Int
  price       BigInt
  orders      orders    @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  souvenirs   souvenirs @relation(fields: [souvenir_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([order_id])
}
